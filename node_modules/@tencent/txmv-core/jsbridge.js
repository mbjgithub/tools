'use strict';
var getScript = require("./util/getScript");
var ua = require('@tencent/txv.ua')();
var report = require("./monitor/report");
/**
 * 手Q 微信 腾讯视频app各种bridge的facade
 */
var _callbacks = [];
var _ready = false;
var _bridge = null;
var _status = Object.create({}, {
	ready: {
		set: function (v) {
			if (_ready == v) {
				return;
			}
			_ready = v;
			report("//btrace.qq.com/kvcollect?BossId=3882&Pwd=784260133" +
				"&event=" + (ua.browser.name + (_bridge ? 'suc': 'fail')) +
				"&ua=" + navigator.userAgent +
				"&qq=0&vuserid=0&main_login=0&" +
				"refer=" + document.referrer +
				"&url=" + location.href +
				"&_dc=" + Math.random());
			var cb;
			while (cb = _callbacks.shift()) {
				setTimeout((function (cb) {
				    return function () {
					    cb(_bridge);
				    }
				})(cb), 0);
			}
		},
		get: function () {
			return _ready;
		}
	}
});

module.exports = function (cb) {
	if (_status.ready) {
		cb(_bridge);
	} else {
		_callbacks.push(cb);
	}
};

if (ua.browser.WeChat) {
	var jsready = false;
	var bridgeready = false;

	var ready = function (name) {
		if (name == 'bridge') bridgeready = true;
		if (name == 'js') jsready = true;

		if (jsready && bridgeready) {
			_bridge = win.WeixinJSBridge;
			_status.ready = true;
		}
	};

	var win = window == top ? window : top;

	if (!top.WeixinJSBridge) {
		try {
			win.document.addEventListener("WeixinJSBridgeReady", function () {
				ready('bridge');
			});

		} catch (e) {
			_bridge = null;
			_status.ready = true;
		}

	} else {
		ready('bridge')
	}

	if (!win.wx) {
		getScript('//res.wx.qq.com/open/js/jweixin-1.2.0.js', function () {
			ready('js');
		})
	} else {
		ready('js')
	}

	setTimeout(function () {
		if (!_status.ready) {
			_bridge = null;
			_status.ready = true;
		}
	}, 10000);

} else if (ua.browser.MQQClient) {

	if (window.mqq || window.QQApi) {
		_bridge = window.mqq || window.QQApi;
		_status.ready = true;

	} else {
		var apiurl = '//s.url.cn/qqmobile/qqapi.js?_bid=152';
		getScript(apiurl, function () {
			_bridge = window.mqq || window.QQApi;
			_status.ready = true;
		});
	}
	setTimeout(function () {
		if (!_status.ready) {
			_bridge = null;
			_status.ready = true;
		}
	}, 6000);

} else if (ua.browser.QQvideo) {
	if (window.TenvideoJSBridge || window.WebViewJavascriptBridge) {
		QQLiveReady()

	} else {
		document.addEventListener('onTenvideoJSBridgeReady', QQLiveReady);
		document.addEventListener('WebViewJavascriptBridgeReady', QQLiveReady);
		var timer = setInterval(function () {
			if (window.TenvideoJSBridge || window.WebViewJavascriptBridge) {
				clearInterval(timer);
				QQLiveReady();
			} else if (_status.ready) {
				clearInterval(timer);
			}

		}, 200);
		setTimeout(function () {
			if (!_status.ready) {
				_bridge = null;
				_status.ready = true;
			}
		}, 6000);
	}

} else if (ua.browser.qqnews) {

	if (window.TencentNews) {
		_bridge = window.TencentNews;
		_status.ready = true;

	} else {
		getScript('http://mat1.gtimg.com/www/js/newsapp/jsapi/news.js?_tsid=1', function () {
			if (window.TencentNews) {
				_bridge = window.TencentNews;
				_status.ready = true;

			} else {
				// ios下偶现拉完js依然没对象，我草。
				var timer = setInterval(function () {
					if (window.TencentNews || _status.ready) {
						clearInterval(timer);
						_bridge = window.TencentNews;
						_status.ready = true;
					}
				}, 500)
			}
		});
	}
	setTimeout(function () {
		if (!_status.ready) {
			_bridge = null;
			_status.ready = true;
		}
	}, 6000);
} else {
	_bridge = null;
	_status.ready = false;
}

function QQLiveReady() {
	if (window.WebViewJavascriptBridge) {
		window.TenvideoJSBridge = window.WebViewJavascriptBridge;
		window.TenvideoJSBridge.invoke = window.WebViewJavascriptBridge.callHandler;
		window.TenvideoJSBridge.on = window.WebViewJavascriptBridge.registerHandler;
	}
	_bridge = window.TenvideoJSBridge;
	_status.ready = true;
}